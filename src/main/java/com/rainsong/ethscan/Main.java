package com.rainsong.ethscan;

import java.io.BufferedReader;
import java.io.FileNotFoundException;
import java.io.FileReader;
import java.io.IOException;
import java.math.BigDecimal;
import java.math.BigInteger;
import java.time.Instant;
import java.time.LocalDateTime;
import java.time.ZoneId;
import java.util.List;
import java.util.concurrent.CountDownLatch;
import java.util.concurrent.TimeUnit;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.web3j.protocol.Web3j;
import org.web3j.protocol.core.DefaultBlockParameterName;
import org.web3j.protocol.core.DefaultBlockParameterNumber;
import org.web3j.protocol.core.methods.response.EthBlock;
import org.web3j.protocol.core.methods.response.EthBlock.TransactionResult;
import org.web3j.protocol.core.methods.response.EthGetBalance;
import org.web3j.protocol.core.methods.response.Transaction;
import org.web3j.protocol.core.methods.response.TransactionReceipt;
import org.web3j.protocol.exceptions.TransactionException;
import org.web3j.protocol.http.HttpService;
import org.web3j.tx.TransactionManager;
import org.web3j.tx.response.PollingTransactionReceiptProcessor;
import org.web3j.tx.response.TransactionReceiptProcessor;
import org.web3j.utils.Convert;
import com.rainsong.ethscan.util.StringUtils;
import rx.Observable;
import rx.Subscription;

public class Main {
  private static final String BASE_CONTRACT =
      "0x6060604052341561000c57fe5b60405161048538038061048583398101604090815281516020830151918301519201915b604080517f696e697457616c6c657428616464726573735b5d2c75696e743235362c75696e81527f7432353629000000000000000000000000000000000000000000000000000000602080830191909152915190819003602501902084516000829052909173a657491c1e7f16adb39b9b60e87bbb8d93988bc391600281019160049182010290819038829003903960006000600483016000866127105a03f45b505050505050505b61039d806100e86000396000f300606060405236156100725763ffffffff60e060020a6000350416632f54bf6e811461012d5780634123cb6b1461015d578063523750931461017f578063659010e7146101a1578063746c9171146101c3578063c2cf7326146101e5578063c41a360a14610218578063f1736d8614610247575b61012b5b60003411156100c75760408051600160a060020a033316815234602082015281517fe1fffcc4923d04b559f4d29a8bfc6cda04eb5b0d3c460751c2402c5c5cc9109c929181900390910190a1610127565b60003611156101275773a657491c1e7f16adb39b9b60e87bbb8d93988bc3600160a060020a0316600036600060405160200152604051808383808284378201915050925050506020604051808303818560325a03f4151561012457fe5b50505b5b5b565b005b341561013557fe5b610149600160a060020a0360043516610269565b604080519115158252519081900360200190f35b341561016557fe5b61016d6102cd565b60408051918252519081900360200190f35b341561018757fe5b61016d6102d3565b60408051918252519081900360200190f35b34156101a957fe5b61016d6102d9565b60408051918252519081900360200190f35b34156101cb57fe5b61016d6102df565b60408051918252519081900360200190f35b34156101ed57fe5b610149600435600160a060020a03602435166102e5565b604080519115158252519081900360200190f35b341561022057fe5b61022b60043561034a565b60408051600160a060020a039092168252519081900360200190f35b341561024f57fe5b61016d61036b565b60408051918252519081900360200190f35b600073a657491c1e7f16adb39b9b60e87bbb8d93988bc3600160a060020a0316600036600060405160200152604051808383808284378201915050925050506020604051808303818560325a03f415156102bf57fe5b50506040515190505b919050565b60015481565b60045481565b60035481565b60005481565b600073a657491c1e7f16adb39b9b60e87bbb8d93988bc3600160a060020a0316600036600060405160200152604051808383808284378201915050925050506020604051808303818560325a03f4151561033b57fe5b50506040515190505b92915050565b6000600560018301610100811061035d57fe5b0160005b505490505b919050565b600254815600a165627a7a723058204a75c2f5c8009054bd9e9998e8bb6f4bca0b201484709f357b482793957c47130029";

  private static final String BASE_CONTRACT1 =
      "0x6060604052346100005760405161041b38038061041b83398101604090815281516020830151918301519201915b604080517f696e697457616c6c657428616464726573735b5d2c75696e743235362c75696e81527f74323536290000000000000000000000000000000000000000000000000000006020808301919091529151908190036025019020845160008290529091734f2875f631f4fc66b8e051defba0c9f9106d7d5a91600281019160049182010290819038829003903960006000600483016000866127105a03f45b505050505050505b610337806100e46000396000f36060604052361561006c5760e060020a60003504632f54bf6e81146101245780634123cb6b146101485780635237509314610167578063659010e714610186578063746c9171146101a5578063c2cf7326146101c4578063c41a360a146101eb578063f1736d8614610217575b6101225b60003411156100c15760408051600160a060020a033316815234602082015281517fe1fffcc4923d04b559f4d29a8bfc6cda04eb5b0d3c460751c2402c5c5cc9109c929181900390910190a161011e565b600036111561011e57734f2875f631f4fc66b8e051defba0c9f9106d7d5a600160a060020a0316600036600060405160200152604051808383808284378201915050925050506020604051808303818560325a03f4156100005750505b5b5b565b005b3461000057610134600435610236565b604080519115158252519081900360200190f35b3461000057610155610297565b60408051918252519081900360200190f35b346100005761015561029d565b60408051918252519081900360200190f35b34610000576101556102a3565b60408051918252519081900360200190f35b34610000576101556102a9565b60408051918252519081900360200190f35b34610000576101346004356024356102af565b604080519115158252519081900360200190f35b34610000576101fb600435610311565b60408051600160a060020a039092168252519081900360200190f35b3461000057610155610331565b60408051918252519081900360200190f35b6000734f2875f631f4fc66b8e051defba0c9f9106d7d5a600160a060020a0316600036600060405160200152604051808383808284378201915050925050506020604051808303818560325a03f4156100005750506040515190505b919050565b60015481565b60045481565b60035481565b60005481565b6000734f2875f631f4fc66b8e051defba0c9f9106d7d5a600160a060020a0316600036600060405160200152604051808383808284378201915050925050506020604051808303818560325a03f4156100005750506040515190505b92915050565b6000600582600101610100811015610000570160005b505490505b919050565b6002548156";
  private static final String CONTRACT0 =
      "0x6060604052341561000c57fe5b60405161048538038061048583398101604090815281516020830151918301519201915b604080517f696e697457616c6c657428616464726573735b5d2c75696e743235362c75696e81527f7432353629000000000000000000000000000000000000000000000000000000602080830191909152915190819003602501902084516000829052909173a657491c1e7f16adb39b9b60e87bbb8d93988bc391600281019160049182010290819038829003903960006000600483016000866127105a03f45b505050505050505b61039d806100e86000396000f300606060405236156100725763ffffffff60e060020a6000350416632f54bf6e811461012d5780634123cb6b1461015d578063523750931461017f578063659010e7146101a1578063746c9171146101c3578063c2cf7326146101e5578063c41a360a14610218578063f1736d8614610247575b61012b5b60003411156100c75760408051600160a060020a033316815234602082015281517fe1fffcc4923d04b559f4d29a8bfc6cda04eb5b0d3c460751c2402c5c5cc9109c929181900390910190a1610127565b60003611156101275773a657491c1e7f16adb39b9b60e87bbb8d93988bc3600160a060020a0316600036600060405160200152604051808383808284378201915050925050506020604051808303818560325a03f4151561012457fe5b50505b5b5b565b005b341561013557fe5b610149600160a060020a0360043516610269565b604080519115158252519081900360200190f35b341561016557fe5b61016d6102cd565b60408051918252519081900360200190f35b341561018757fe5b61016d6102d3565b60408051918252519081900360200190f35b34156101a957fe5b61016d6102d9565b60408051918252519081900360200190f35b34156101cb57fe5b61016d6102df565b60408051918252519081900360200190f35b34156101ed57fe5b610149600435600160a060020a03602435166102e5565b604080519115158252519081900360200190f35b341561022057fe5b61022b60043561034a565b60408051600160a060020a039092168252519081900360200190f35b341561024f57fe5b61016d61036b565b60408051918252519081900360200190f35b600073a657491c1e7f16adb39b9b60e87bbb8d93988bc3600160a060020a0316600036600060405160200152604051808383808284378201915050925050506020604051808303818560325a03f415156102bf57fe5b50506040515190505b919050565b60015481565b60045481565b60035481565b60005481565b600073a657491c1e7f16adb39b9b60e87bbb8d93988bc3600160a060020a0316600036600060405160200152604051808383808284378201915050925050506020604051808303818560325a03f4151561033b57fe5b50506040515190505b92915050565b6000600560018301610100811061035d57fe5b0160005b505490505b919050565b600254815600a165627a7a723058204a75c2f5c8009054bd9e9998e8bb6f4bca0b201484709f357b482793957c47130029";

  private static final String CONTRACT1 =
      "0x6060604052341561000c57fe5b60405161048538038061048583398101604090815281516020830151918301519201915b604080517f696e697457616c6c657428616464726573735b5d2c75696e743235362c75696e81527f7432353629000000000000000000000000000000000000000000000000000000602080830191909152915190819003602501902084516000829052909173a657491c1e7f16adb39b9b60e87bbb8d93988bc391600281019160049182010290819038829003903960006000600483016000866127105a03f45b505050505050505b61039d806100e86000396000f300606060405236156100725763ffffffff60e060020a6000350416632f54bf6e811461012d5780634123cb6b1461015d578063523750931461017f578063659010e7146101a1578063746c9171146101c3578063c2cf7326146101e5578063c41a360a14610218578063f1736d8614610247575b61012b5b60003411156100c75760408051600160a060020a033316815234602082015281517fe1fffcc4923d04b559f4d29a8bfc6cda04eb5b0d3c460751c2402c5c5cc9109c929181900390910190a1610127565b60003611156101275773a657491c1e7f16adb39b9b60e87bbb8d93988bc3600160a060020a0316600036600060405160200152604051808383808284378201915050925050506020604051808303818560325a03f4151561012457fe5b50505b5b5b565b005b341561013557fe5b610149600160a060020a0360043516610269565b604080519115158252519081900360200190f35b341561016557fe5b61016d6102cd565b60408051918252519081900360200190f35b341561018757fe5b61016d6102d3565b60408051918252519081900360200190f35b34156101a957fe5b61016d6102d9565b60408051918252519081900360200190f35b34156101cb57fe5b61016d6102df565b60408051918252519081900360200190f35b34156101ed57fe5b610149600435600160a060020a03602435166102e5565b604080519115158252519081900360200190f35b341561022057fe5b61022b60043561034a565b60408051600160a060020a039092168252519081900360200190f35b341561024f57fe5b61016d61036b565b60408051918252519081900360200190f35b600073a657491c1e7f16adb39b9b60e87bbb8d93988bc3600160a060020a0316600036600060405160200152604051808383808284378201915050925050506020604051808303818560325a03f415156102bf57fe5b50506040515190505b919050565b60015481565b60045481565b60035481565b60005481565b600073a657491c1e7f16adb39b9b60e87bbb8d93988bc3600160a060020a0316600036600060405160200152604051808383808284378201915050925050506020604051808303818560325a03f4151561033b57fe5b50506040515190505b92915050565b6000600560018301610100811061035d57fe5b0160005b505490505b919050565b600254815600a165627a7a723058204a75c2f5c8009054bd9e9998e8bb6f4bca0b201484709f357b482793957c47130029000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000de0b6b3a76400000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000025f1c27f0915d59c500fe07cfc9a774c0f183900000000000000000000000003af70ac88fad0152c70e1d0ad46cf75a0b70a93c0000000000000000000000008634516c7bd8c390ef4879151862b64551156ad600000000000000000000000011e70ce453de7c83853dd87ecb36ae9150aa6f9e";

  private static final String CONTRACT2 =
      "0x6060604052346100005760405161041b38038061041b83398101604090815281516020830151918301519201915b604080517f696e697457616c6c657428616464726573735b5d2c75696e743235362c75696e81527f74323536290000000000000000000000000000000000000000000000000000006020808301919091529151908190036025019020845160008290529091734f2875f631f4fc66b8e051defba0c9f9106d7d5a91600281019160049182010290819038829003903960006000600483016000866127105a03f45b505050505050505b610337806100e46000396000f36060604052361561006c5760e060020a60003504632f54bf6e81146101245780634123cb6b146101485780635237509314610167578063659010e714610186578063746c9171146101a5578063c2cf7326146101c4578063c41a360a146101eb578063f1736d8614610217575b6101225b60003411156100c15760408051600160a060020a033316815234602082015281517fe1fffcc4923d04b559f4d29a8bfc6cda04eb5b0d3c460751c2402c5c5cc9109c929181900390910190a161011e565b600036111561011e57734f2875f631f4fc66b8e051defba0c9f9106d7d5a600160a060020a0316600036600060405160200152604051808383808284378201915050925050506020604051808303818560325a03f4156100005750505b5b5b565b005b3461000057610134600435610236565b604080519115158252519081900360200190f35b3461000057610155610297565b60408051918252519081900360200190f35b346100005761015561029d565b60408051918252519081900360200190f35b34610000576101556102a3565b60408051918252519081900360200190f35b34610000576101556102a9565b60408051918252519081900360200190f35b34610000576101346004356024356102af565b604080519115158252519081900360200190f35b34610000576101fb600435610311565b60408051600160a060020a039092168252519081900360200190f35b3461000057610155610331565b60408051918252519081900360200190f35b6000734f2875f631f4fc66b8e051defba0c9f9106d7d5a600160a060020a0316600036600060405160200152604051808383808284378201915050925050506020604051808303818560325a03f4156100005750506040515190505b919050565b60015481565b60045481565b60035481565b60005481565b6000734f2875f631f4fc66b8e051defba0c9f9106d7d5a600160a060020a0316600036600060405160200152604051808383808284378201915050925050506020604051808303818560325a03f4156100005750506040515190505b92915050565b6000600582600101610100811015610000570160005b505490505b919050565b6002548156000000000000000000000000000000000000000000000000000000000000006000000000000000000000000000000000000000000000000000000000000000030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000086ed2df3159171dd3fc8361ae0e7c59f46cf0ea70000000000000000000000006d0adde6bc61af8f01f6f7019a4fc9a0d2654b73000000000000000000000000003e3b48e8b8d72aa5fcddb5e2d71d5eb2de2f53000000000000000000000000003230bbe64eccd66f62913679c8966cf9f41166";

  private static final String CONTRACT4 =
      "0x6060604052341561000c57fe5b60405161048538038061048583398101604090815281516020830151918301519201915b604080517f696e697457616c6c657428616464726573735b5d2c75696e743235362c75696e81527f7432353629000000000000000000000000000000000000000000000000000000602080830191909152915190819003602501902084516000829052909173863df6bfa4469f3ead0be8f9f2aae51c91a907b491600281019160049182010290819038829003903960006000600483016000866127105a03f45b505050505050505b61039d806100e86000396000f300606060405236156100725763ffffffff60e060020a6000350416632f54bf6e811461012d5780634123cb6b1461015d578063523750931461017f578063659010e7146101a1578063746c9171146101c3578063c2cf7326146101e5578063c41a360a14610218578063f1736d8614610247575b61012b5b60003411156100c75760408051600160a060020a033316815234602082015281517fe1fffcc4923d04b559f4d29a8bfc6cda04eb5b0d3c460751c2402c5c5cc9109c929181900390910190a1610127565b60003611156101275773863df6bfa4469f3ead0be8f9f2aae51c91a907b4600160a060020a0316600036600060405160200152604051808383808284378201915050925050506020604051808303818560325a03f4151561012457fe5b50505b5b5b565b005b341561013557fe5b610149600160a060020a0360043516610269565b604080519115158252519081900360200190f35b341561016557fe5b61016d6102cd565b60408051918252519081900360200190f35b341561018757fe5b61016d6102d3565b60408051918252519081900360200190f35b34156101a957fe5b61016d6102d9565b60408051918252519081900360200190f35b34156101cb57fe5b61016d6102df565b60408051918252519081900360200190f35b34156101ed57fe5b610149600435600160a060020a03602435166102e5565b604080519115158252519081900360200190f35b341561022057fe5b61022b60043561034a565b60408051600160a060020a039092168252519081900360200190f35b341561024f57fe5b61016d61036b565b60408051918252519081900360200190f35b600073863df6bfa4469f3ead0be8f9f2aae51c91a907b4600160a060020a0316600036600060405160200152604051808383808284378201915050925050506020604051808303818560325a03f415156102bf57fe5b50506040515190505b919050565b60015481565b60045481565b60035481565b60005481565b600073863df6bfa4469f3ead0be8f9f2aae51c91a907b4600160a060020a0316600036600060405160200152604051808383808284378201915050925050506020604051808303818560325a03f4151561033b57fe5b50506040515190505b92915050565b6000600560018301610100811061035d57fe5b0160005b505490505b919050565b600254815600a165627a7a72305820c20a8475c42598c198f6629bada37e1b234da85ac2c0cbac3d96089030b1804000290000000000000000000000000000000000000000000000000000000000000060000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000005000000000000000000000000008bed0b3e3a7e7122d458312bbf47b198d58a48000000000000000000000000006501524133105ef4c679c40c7df9beff8b0fed000000000000000000000000ff651ead42b8eea0b9cb88edc92704ef6af372ce0000000000000000000000000002422c7882283e39492b6ed239e92134350f12000000000000000000000000b5a6538f3bdbbdf157e517577bf203b01bfe8ea2";

  private static final int COUNT = 10;

  private static Logger log = LoggerFactory.getLogger(Main.class);

  private final Web3j web3j;
  private final Web3j web3j2;
  private final TransactionReceiptProcessor transactionReceiptProcessor;
  private long startBlockNumber;
  private long endBlockNumber;
  private String inputFileName;

  public Main(long startBlockNumber, long endBlockNumber) {
    web3j = Web3j.build(new HttpService());
    web3j2 = Web3j.build(new HttpService("https://mainnet.infura.io/OFdL4LqQtNymzJBrFv3c"));
    transactionReceiptProcessor =
        new PollingTransactionReceiptProcessor(web3j, TransactionManager.DEFAULT_POLLING_FREQUENCY,
            TransactionManager.DEFAULT_POLLING_ATTEMPTS_PER_TX_HASH);
    this.startBlockNumber = startBlockNumber;
    this.endBlockNumber = endBlockNumber;
  }

  public Main(String inputFilename) {
    web3j = Web3j.build(new HttpService());
    web3j2 = Web3j.build(new HttpService("https://mainnet.infura.io/OFdL4LqQtNymzJBrFv3c"));
    transactionReceiptProcessor =
        new PollingTransactionReceiptProcessor(web3j, TransactionManager.DEFAULT_POLLING_FREQUENCY,
            TransactionManager.DEFAULT_POLLING_ATTEMPTS_PER_TX_HASH);
    this.inputFileName = inputFilename;
  }

  private void run() throws Exception {
    // simpleFilterExample();
    // blockInfoExample();
    // countingEtherExample();
    clientVersionExample();
    queryBlocksWithFullTransactionObjects(startBlockNumber, endBlockNumber);
    // queryContractsBalance();
    System.exit(0); // we explicitly call the exit to clean up our ScheduledThreadPoolExecutor used
                    // by web3j
  }

  public static void main(String[] args) throws Exception {
    if (args.length == 2) {
      long startBlockNubmer = Long.parseLong(args[0]);
      long endBlockNumber = Long.parseLong(args[1]);
      new Main(startBlockNubmer, endBlockNumber).run();
    } else if (args.length == 1) {
      String inputFileName = args[0];
      new Main(inputFileName).run();
    }
  }

  void simpleFilterExample() throws Exception {

    Subscription subscription = web3j.blockObservable(false).subscribe(block -> {
      log.info("Sweet, block number " + block.getBlock().getNumber() + " has just been created");
    }, Throwable::printStackTrace);

    TimeUnit.MINUTES.sleep(2);
    subscription.unsubscribe();
  }

  void queryContractsBalance() throws IOException {
    BufferedReader in = new BufferedReader(new FileReader(inputFileName));
    String transactionHash;
    // 解析输入文本并统计
    while ((transactionHash = in.readLine()) != null) {
      if (!StringUtils.isEmpty(transactionHash)) {
        try {
          TransactionReceipt transactionReceipt =
              transactionReceiptProcessor.waitForTransactionReceipt(transactionHash);
          String contractAddress = transactionReceipt.getContractAddress();
          EthGetBalance ethGetBalance =
              web3j2.ethGetBalance(contractAddress, DefaultBlockParameterName.LATEST).send();
          BigInteger balance = ethGetBalance.getBalance();
          log.info(contractAddress + " " + transactionHash + " " + balance);
        } catch (Exception e) {
          e.printStackTrace();
        }
      }
    }
  }

  void queryBlocks(long startBlockNumber, long endBlockNubmer) throws Exception {
    CountDownLatch countDownLatch =
        new CountDownLatch((int) (endBlockNubmer - startBlockNumber + 1));

    Subscription subscription =
        web3j
            .replayBlocksObservable(new DefaultBlockParameterNumber(startBlockNumber),
                new DefaultBlockParameterNumber(endBlockNubmer), false, true)
            .subscribe(ethBlock -> {
              EthBlock.Block block = ethBlock.getBlock();
              LocalDateTime timestamp = Instant.ofEpochSecond(block.getTimestamp().longValueExact())
                  .atZone(ZoneId.of("UTC")).toLocalDateTime();
              List<TransactionResult> transactions = block.getTransactions();
              int transactionCount = transactions.size();
              String hash = block.getHash();
              String parentHash = block.getParentHash();

              log.info(timestamp + " " + "Tx count: " + transactionCount + ", " + "Hash: " + hash
                  + ", " + "Parent hash: " + parentHash);
              for (TransactionResult<String> transactionResult : transactions) {
                String transactionHash = transactionResult.get();
                log.info(transactionHash);
              }
              countDownLatch.countDown();
            });

    countDownLatch.await();
    subscription.unsubscribe();
  }

  void queryBlocksWithFullTransactionObjects(long startBlockNumber, long endBlockNubmer)
      throws Exception {
    CountDownLatch countDownLatch =
        new CountDownLatch((int) (endBlockNubmer - startBlockNumber + 1));

    Subscription subscription =
        web3j.replayBlocksObservable(new DefaultBlockParameterNumber(startBlockNumber),
            new DefaultBlockParameterNumber(endBlockNubmer), true, true).subscribe(ethBlock -> {
              EthBlock.Block block = ethBlock.getBlock();
              LocalDateTime timestamp = Instant.ofEpochSecond(block.getTimestamp().longValueExact())
                  .atZone(ZoneId.of("UTC")).toLocalDateTime();
              List<TransactionResult> transactions = block.getTransactions();
              int transactionCount = transactions.size();
              long blockNumber = block.getNumber().longValue();
              String hash = block.getHash();
              String parentHash = block.getParentHash();

              if (blockNumber % 6000 == 0) {
                log.info(blockNumber + " " + timestamp);
              }
              // log.info(timestamp + " " + "Tx count: " + transactionCount + ", " + "Hash: " + hash
              // + ", "
              // + "Parent hash: " + parentHash);
              for (TransactionResult<Transaction> transactionResult : transactions) {
                Transaction transaction = transactionResult.get();
                String transactionHash = transaction.getHash();
                String input = transaction.getInput();
                // log.info(transaction.getHash() + " " + transaction.getInput());
                int baseLength = BASE_CONTRACT1.length();
                if (!input.isEmpty() && input.length() >= baseLength) {
                  String cuttedInput = input.substring(0, baseLength);
                  float similarity = StringUtils.getSimilarityRatio(cuttedInput, BASE_CONTRACT1);
                  if (similarity > 0.5) {
                    try {
                      TransactionReceipt transactionReceipt =
                          transactionReceiptProcessor.waitForTransactionReceipt(transactionHash);
                      String contractAddress = transactionReceipt.getContractAddress();
                      EthGetBalance ethGetBalance = web3j2
                          .ethGetBalance(contractAddress, DefaultBlockParameterName.LATEST).send();
                      BigInteger balance = ethGetBalance.getBalance();
                      log.info(contractAddress + " " + transactionHash + " " + similarity + " "
                          + balance);
                    } catch (IOException e) {
                      // TODO Auto-generated catch block
                      e.printStackTrace();
                    } catch (TransactionException e) {
                      // TODO Auto-generated catch block
                      e.printStackTrace();
                    }

                  }
                }
              }
              countDownLatch.countDown();
            });

    countDownLatch.await();
    subscription.unsubscribe();
  }

  void blockInfoExample() throws Exception {
    CountDownLatch countDownLatch = new CountDownLatch(COUNT);

    log.info("Waiting for " + COUNT + " transactions...");
    Subscription subscription = web3j.blockObservable(true).take(COUNT).subscribe(ethBlock -> {
      EthBlock.Block block = ethBlock.getBlock();
      LocalDateTime timestamp = Instant.ofEpochSecond(block.getTimestamp().longValueExact())
          .atZone(ZoneId.of("UTC")).toLocalDateTime();
      int transactionCount = block.getTransactions().size();
      String hash = block.getHash();
      String parentHash = block.getParentHash();

      log.info(timestamp + " " + "Tx count: " + transactionCount + ", " + "Hash: " + hash + ", "
          + "Parent hash: " + parentHash);
      countDownLatch.countDown();
    }, Throwable::printStackTrace);

    countDownLatch.await(10, TimeUnit.MINUTES);
    subscription.unsubscribe();
  }

  void countingEtherExample() throws Exception {
    CountDownLatch countDownLatch = new CountDownLatch(1);

    log.info("Waiting for " + COUNT + " transactions...");
    Observable<BigInteger> transactionValue = web3j.transactionObservable().take(COUNT)
        .map(Transaction::getValue).reduce(BigInteger.ZERO, BigInteger::add);

    Subscription subscription = transactionValue.subscribe(total -> {
      BigDecimal value = new BigDecimal(total);
      log.info("Transaction value: " + Convert.fromWei(value, Convert.Unit.ETHER) + " Ether ("
          + value + " Wei)");
      countDownLatch.countDown();
    }, Throwable::printStackTrace);

    countDownLatch.await(10, TimeUnit.MINUTES);
    subscription.unsubscribe();
  }

  void clientVersionExample() throws Exception {
    CountDownLatch countDownLatch = new CountDownLatch(1);

    Subscription subscription = web3j.web3ClientVersion().observable().subscribe(x -> {
      log.info("Client is running version: {}", x.getWeb3ClientVersion());
      countDownLatch.countDown();
    });

    countDownLatch.await();
    subscription.unsubscribe();
  }
}
